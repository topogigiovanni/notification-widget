
<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../bower_components/paper-badge/paper-badge.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">

<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation-behavior.html">
<link rel="import" href="../bower_components/neon-animation/neon-shared-element-animation-behavior.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">

<!-- <link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="my-icons.html"> -->

<link rel="import" href="app-dropdown.html">

<dom-module id="dcg-notification-summary">
	<template>
		<style>
		demo-snippet {
			--demo-snippet-code: {
				max-height: 250px;
			}
		}

		[slot="dropdown-content"] {
			background-color: white;
			line-height: 20px;
			border-radius: 3px;
			/*box-shadow: 0px 2px 6px #ccc;*/
		}

		.random-content {
			/*padding: 1.5em 2em;*/
			border-bottom: 1px solid #e0e0e0;
			background-color: white;
			margin: 0;
			padding: 16px;
			background: var(--paper-grey-200);
				max-width: 250px;
				/*top: 43px;
				position: relative;*/
			}


			/*#dropdown{
			    margin-top: 30px;
			    top: 43px;
			    position: relative;
			    }*/

			    .random-content paper-card {
			    	margin-bottom: 10px;
			    }

			    button {
			    	border: 1px solid #ccc;
			    	background-color: #eee;
			    	padding: 1em;
			    	border-radius: 3px;
			    	cursor: pointer;
			    }

			    button:focus {
			    	outline: none;
			    	border-color: blue;
			    }

			    ul,
			    li {
			    	display: block;
			    	position: relative;
			    	margin: 0;
			    	padding: 0;
			    }

			    a {
			    	display: block;
			    	position: relative;
			    	padding: 1em;
			    	text-decoration: none;
			    }

			    li:not(:last-of-type) {
			    	border-bottom: 1px solid #eee;
			    }

			    a:hover {
			    	text-decoration: underline;
			    }

			    iron-image {
			    	padding: 1em;
			    	background-color: #fff;
			    	box-shadow: 0px 2px 6px #ccc;
			    	border-radius: 3px;
			    }

			    paper-badge {
			    	--paper-badge-background: var(--paper-red-300);
			    		--paper-badge-margin-bottom: -20px;
			    		--paper-badge-margin-left: -10px;
			    	}

			    	app-dropdown {
			    		margin: 0;
			    	}

			    	.dropdown-trigger {
			    		margin: 0;
			    		padding: 0;
			    		position: relative;
			    	}

			    	paper-button {
			    		display: block;
			    		background: #4285f4;
			    		color: #fff;
			    	}

			    	paper-listbox {
			    		display: block;
			    	}

			    	paper-menu-button {
			    		margin: auto;
			    	}

			    	iron-image {
			    		padding: 1em;
			    	}

			    	.item {
			    		max-width: 300px;
			    	}

			    	.random-content paper-menu-button {
			    		float: right;
			    		margin: 0;
			    		padding: 0;
			    	}

			    	.random-content paper-icon-button {
			    		margin: 0;
			    		padding: 0;
			    		width: 20px;
			    	}
			    </style>

			    <app-dropdown allow-outside-scroll="true">

	  <!-- <div style="display:inline-block" slot="dropdown-trigger" >
	    <paper-icon-button id="number2" icon="social:notifications" alt="inbox">
	    </paper-icon-button>
	    <paper-badge for="number2" label="4" class="red">
	    </paper-badge>
	</div> -->

	<div class="dropdown-trigger" slot="dropdown-trigger">
		<paper-icon-button id="number2" icon="social:notifications" alt="inbox">
		</paper-icon-button>
		<paper-badge for="number2" label="[[notificationsCount]]" class="red">
		</paper-badge>
	</div>

	<!-- <button slot="dropdown-trigger">Basic</button> -->
	<div id="notification-list" slot="dropdown-content" class="random-content">
		<iron-scroll-threshold id="mytras" on-lower-threshold="loadMoreData" lower-threshold="40" scroll-target="notification-list">
			<template is="dom-repeat" items="{{list}}">
				<paper-card alt="Emmental">
					<div class="card-content">
						<paper-menu-button horizontal-align="right">
							<paper-icon-button icon="icons:more-vert" slot="dropdown-trigger" alt="menu"></paper-icon-button>
							<paper-listbox slot="dropdown-content">
								<paper-item>alpha</paper-item>
								<paper-item>beta</paper-item>
								<paper-item>gamma</paper-item>
								<paper-item>delta</paper-item>
								<paper-item>epsilon</paper-item>
							</paper-listbox>
						</paper-menu-button>
						[[item.title]]
						<br>
						[[item.message]]
					</div>
				</paper-card>
			</template>
			<paper-spinner-lite active="{{loadingData}}">...</paper-spinner-lite>
		</iron-scroll-threshold>
	</div>
</app-dropdown>

<dcg-notification-splash></dcg-notification-splash>

</template>

<script>
	class NotificationSummary extends Polymer.Element {
		static get is() {
			return 'dcg-notification-summary';
		}

		static get properties() {
			return {
				notificationsCount: {
					type: Number,
					value: 0
				},
				loadedData: {
					type: Number,
					value: 0
				},
				lastLoadedData: {
					type: Number,
					value: 0
				},
				list: {
					type: Array,
					value: []
				},
				loadingData: Boolean,
				finishedLoad: Boolean,
				service: Object
			};
		}

		ready() {
			super.ready()

			console.log('dcg notification ready', DCG, this)

			let service = DCG.notification('getService', 'api')

			service
			.getUnreadNotificationsCount()
			.then((r) => {
				console.log('r getUnreadNotificationsCount 2', r);
				this.notificationsCount = r.count;
				return r;
			})
			.catch((er) => {
				console.log('catch getUnreadNotificationsCount err 2', er);
				return er;
			})

	        // Polymer.import( ['dcg-notification-splash.html'], function() {
	        //   console.log('load spash', arguments)
	        // });

	        Polymer.importHref(this.resolveUrl('dcg-notification-splash.html'),
	        	() => console.log('success load spash', arguments),
	        	() => console.log('error load spash', arguments),
	        	true /* true for async */ );

	    }

	    static get observers() {
	    	return [
	    	'_url(loadedData)'
	    	];
	    }

	    _url(skip){
	    	console.log('_url ------- skip:', skip, this);
	    	// this.url = "https://randomuser.me/api?results=" + p;
	    	// setTimeout(()=> {
	    	// 	console.log('stout', this);
	    	// 	this.$.mytras.clearTriggers();
	    	// },900)

	    	if(this.finishedLoad || (this.lastLoadedData > 0 && skip <= this.lastLoadedData)){
	    		this.loadingData = false
	    		return
	    	}

	    	this.lastLoadedData = skip

	    	let service = DCG.notification('getService', 'api')

	    	service
	    	.getNotifications(skip)
	    	.then((r) => {
	    		console.log('r 1', r);
	    		// debugger;
	    		if(r && r.length){
	    			//this.list = this.list || []
	    			// this.list = this.get('list') || []
	    			r.forEach((i) => this.push('list', i))

	    			// this.set('list', this.list)

	    		}else{
	    			this.finishedLoad = true;
	    		}

	    		console.log('this.list ', this.list );

	    		this.$.mytras.clearTriggers()
	    		this.loadingData = false

	    		//return r;
	    	})
	    	.catch((er) => {
	    		console.log('catch err 1', er);
	    		return er;
	    	})
	    }

	    loadMoreData (){
	    	console.log("God call me for every scroll");
	    	this.loadingData = true;
	    	// this.loaded += 10;
	    	this.loadedData += 3;
	    }
	}

	window.customElements.define(NotificationSummary.is, NotificationSummary);
</script>
</dom-module>
